#coreos-kubernetes-vagrant-ansible-demo
Test setup to run a kubernetes cluster locally with vagrant and the vmware plugin, ansible is also initialized for coreos.

Based on:
[Deploying Kubernetes on CoreOS with Fleet and Flannel](https://github.com/kelseyhightower/kubernetes-fleet-tutorial)

Ansible integration with:
[ansible-coreos-bootstrap](https://github.com/defunctzombie/ansible-coreos-bootstrap)


####Requirements
* [VMware Fusion 7.0](http://www.vmware.com/products/fusion/fusion-evaluation)
* [Vagrant](https://www.vagrantup.com)
    * [vagrant vmware plugin](http://www.vagrantup.com/vmware)
* python
    * pip install vagrant


####Initial setup
Find replace 'myusername' with the current username
```bash
sed -i 's/myusername/'`whoami`'/g' ./configscripts/master.tmpl.yml
sed -i 's/myusername/'`whoami`'/g' ./configscripts/node.tmpl.yml
```
Set gateway in ./config/gateway.txt
```bash
# on osx
netstat -nr | awk 'NR>4'| awk 'NR<2' | awk '{print $2}' > ./config/gateway.txt
```


####CloudConfig
Most customizations are done with [Cloud-Config](https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/), sinces the kubernetes master is different from the nodes two templates are used, [master](./configscripts/master.tmpl.yml) and [node](./configscripts/node.tmpl.yml).

The VM will be configured by a ["user-dateN.yml"](./configscripts/user-data1.yml) file, this gets generated by cluster.py and vagrant.

Extra aliases can be added in [envvars.sh](./config/envvars.sh)

####Start cluster
The 'createcluster.sh' script initializes the vm's and runs the initial ansible playbooks.

```bash
./createcluster.sh
```

####Cluster tool
After the cluster is up you can use the clustertool to run task, most common are:

######Connect to a server
```bash
# connect to core1
python cluster.py -s core1

# connect to 1
python cluster.py -s 3
```

######Run commands on all the servers
```bash
python cluster.py -c "date"
remote command: date

core1:
Fri Feb 20 10:27:28 CET 2015

core2:
Fri Feb 20 10:27:28 CET 2015

core3:
Fri Feb 20 10:27:28 CET 2015
```

######Run ansible playbooks
```bash
python cluster.py -p all:./playbooks/testansible.yml
```

######Show config
```bash
python cluster.py -p
```

######Replace the Cloud-Config files on all servers
```bash
# ./configscripts/master.tmpl.yml -> ./configscripts/user-data1.yml
# ./configscripts/node.tmpl.yml -> ./configscripts/user-data2-n.yml
python cluster.py -a
```

######All arguments
```bash
Vagrant controller, argument 'all' is whole cluster

optional arguments:
  -h, --help            show this help message and exit
  -s [SSH [SSH ...]], --ssh [SSH [SSH ...]]
                        vagrant ssh
  -c [COMMAND [COMMAND ...]], --command [COMMAND [COMMAND ...]]
                        execute command on cluster
  -u UP, --up UP        vagrant up
  -d, --destroy         vagrant destroy -f
  -k HALT, --halt HALT  vagrant halt
  -q, --vagrantprovision
  -r [RELOAD [RELOAD ...]], --reload [RELOAD [RELOAD ...]]
                        vagrant reload
  -t, --token           print a new token
  -n CLOUDCONFIG, --cloudconfig CLOUDCONFIG
                        update cloudconfig (find:replace)
  -w WAIT, --wait WAIT  wait between server (-1 == enter)
  -l [LOCALIZEMACHINE [LOCALIZEMACHINE ...]], --localizemachine [LOCALIZEMACHINE [LOCALIZEMACHINE ...]]
                        apply specific configuration for a machine
```

####Delete cluster
To delete everything

```bash
./deletecluster.sh
```

